Модель лёгких пневматическая электронная МЛП-1Э - .msi пакет
============================================================

Данный проект - .msi пакет для развёртывания в рамках домена программного продукта для управления
моделью лёгких пневматической электронной [МЛП-1Э][].

В состав пакета включены так же и драйверы для подключения модели к компьютеру.

Инструменты для сборки .msi пакета
----------------------------------

Для внесения изменений в пакет и повторной сборки пакета потребуются следующие продукты:

- Microsoft Visual Studio 2012 Shell:
  - [Isolated](http://www.microsoft.com/ru-ru/download/details.aspx?id=30670)
  - [Integrated](http://www.microsoft.com/ru-ru/download/details.aspx?id=30663)
- [Windows Installer XML Toolset - WIX](http://wixtoolset.org/)
- [Windows Driver Kit][WDK]

Установить необходимо все пакеты в указанном порядке. В результате - получае MS Visual Studio 2012 с подготовленными
шаблонами проектов WiX. После этого открываем файл решения `MLP-1E.sln` и собираем решение.

Варианты пакетов
----------------

### Административная точка установки

В папке `bin\Admin image\x86\ru-RU` собран проект, подготовленный к роли административной точки установки.
В нём отсутствует интерфейс пользователя.

### .msi пакет в виде единого файла

В папке `bin\Single .msi file\x86\ru-RU` собран .msi пакет в виде единого файла.
В отличии от предыдущего варианта, в данной редакции присутствует интерфейс пользователя,
позволяющий изменить и состав продукта, и папку его установки.

При необходимости создания административной точки установки с интерфейсом пользователя следует воспользоваться
командной строкой по следующему примеру:

    msiexec -a "bin\Single .msi file\x86\ru-RU\mlp-1e.msi" TARGETDIR="adm\x86"

Подготовка административной точки установки
-------------------------------------------

При подготовке административной точки установки доступны к изменении нижеописанные свойства.

### ALLUSERS

По умолчанию - `"1"`. При установке `"0"` регистрация будет осуществлена в реестре пользователя, а не в реестре компьютера.

### DISABLESHORTCUTS

По умолчанию - `"No"`. При установке значения `"Yes"` при установке не будут опубликованы ярлыки.
Данным свойством следует воспользоваться, если Вы планируете запускать приложения АИС Метроконтроль через ярлыки на
`.csmdb23` файлы (о данных дополнительных возможностях пакета читайте далее).

### DISABLEDESKTOPSHORTCUTS

По умолчанию - `"No"`. При установке значения `"Yes"` при установке не будут опубликованы ярлыки на рабочем столе.
При `DISABLESHORTCUTS="Yes"` значение данного свойства роли не играет.

### DISABLEMENUSHORTCUTS

По умолчанию - `"No"`. При установке значения `"Yes"` при установке не будут опубликованы ярлыки в меню.
При `DISABLESHORTCUTS="Yes"` значение данного свойства роли не играет.

### DISABLESTARTUPSHORTCUTS

По умолчанию - `"Yes"`. При установке значения `"Yes"` при установке не будут опубликованы ярлык на АИС Метроконтроль
в меню автозагрузки. При `DISABLESHORTCUTS="Yes"` значение данного свойства роли не играет.

### APPLICATIONFOLDER

Путь к папке, в которую будет установлен программный продукт. По умолчанию - `%ProgramFiles(x86)%\РЦН\Метроконтроль\2.3%`.
Устанавливать в качестве значения данного свойства требуется только путь по отношению к `%ProgramFiles%`.

### INSTALLLEVEL

По умолчанию - `"100"`. По умолчнию будут установлены только приложения "АИС Метроконтроль" и "Учёт клейм".
При установке `INSTALLLEVEL` больше 200 будет установлено и приложение "Метроконтроль - администратор".

### Примеры

Несколько примеров подготовки административной точки установки:

	msiexec -a mlp-1e.msi DISABLEDESKTOPSHORTCUTS=Yes ALLUSERS=0

Данная командная строка готовит точку установки с "отключенными" ярлыками рабочего стола, с установкой приложения для пользователя
(а не для компьютера).

	msiexec -a mlp-1e.msi DISABLESHORTCUTS=Yes

Данная командная строка готовит точку установки с "отключенными" ярлыками.

Прочее
---------------------------------

### Драйверы

Данный программный продукт содержит драйверы для подключения МЛП-1Э через USB порт. Однако, не выполнены [требования Windows по подписи
драйверов](http://msdn.microsoft.com/library/windows/hardware/gg487317).

Собственно `.sys` файлы не имеют цифровой подписи. Но подписи на данных файлах не являются обязательными,
достаточно подписанного каталога безопасности. 

Да, создан каталог безопасности (`.cat` файлы), однако в этих файлах отсутствует контрольная сумма `.inf` файлов, а также сами файлы
драйверов и файлы каталогов безопасности не подписаны.

Для генерации `.cat` файлов, соответствующих требованиям Windows 7, Windows 8 потребуется [WDK][].
Генерируем новые каталоги безопасности:

	inf2cat /driver:. /os:XP_X86,XP_X64,Vista_X86,Vista_X64,7_X86,7_X64,8_X86,8_X64 

Естественно, текущим каталогом должен быть каталог, в котором находятся `.inf` файлы драйверов.
Однако, для генерации каталога безопасности драйвера для Windows 8 дата обновления драйвера
должна быть позднее 27.04.2012, а у нас драйверы 2007 года.
Предпочёл изменить дату драйвера в `.inf` файле на текущую.

Для подписи файлов каталогов безопасности:

	signtool sign /a /t http://timestamp.verisign.com/scripts/timstamp.dll slabser.cat
	signtool sign /a /t http://timestamp.verisign.com/scripts/timstamp.dll slabbus.cat

Подпись каталога безопасности идентифицирует издателя драйвера, поэтому с целью исключения
возможных запросов при установке драйвера, сертификат издателя (сертификат цифровой подписи
каталога безопасности драйвера) должен находиться в контейнере доверенных издателей на
целевом компьютере. При этом доверия к центру сертификации, выдавшему этот сертификат,
недостаточно, запрос в этому случае всё равно возникает.

Сам сертификат, которым подписаны на текущий момент каталоги безопасности и исполняемые файлы,
включил в проект (issuer.cer). Это сертификат следует через групповую политику импортировать
на все рабочие станции домена в хранилище "Доверенные издатели". Либо же Вы можете переподписать
все файлы Вашим собственным сертификатом и собрать `.msi` пакеты уже с Вашими сертификатами.
После выполнения указанных выше действий драйверы устанавливаются и на Windows 8 без единого
вопроса.

[МЛП-1Э]: http://www.insovt.ru/medequip/mlp.php "Модель лёгких пневмотическая электрическая МЛП-1Э"
[WDK]: http://msdn.microsoft.com/ru-ru/windows/hardware/hh852362 "Windows Driver Kit 8"